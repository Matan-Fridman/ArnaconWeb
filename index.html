<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDK Interface</title>
</head>
<body>
    <iframe id="screen" src=""></iframe>
    <script>
        class Controller {
            constructor(background) {
                this.urls = {
                    "main": background
                };
                const iframe = document.getElementById("screen");
                iframe.src = background;
                this.callbacks = {};
            }

            setPage(pageId, param = {}) {
                console.log("param", param, Object.keys(param).length);
                const iframe = document.getElementById("screen");
                if (iframe) {
                    iframe.src = this.urls[pageId];
                    if (Object.keys(param).length >= 1) {
                        iframe.src += `?${param.key}=${param.value}`;
                    }
                    console.log(iframe.src);
                }
            }

            sendMessageToNativeApp(jsonData, callback = null) {
                if (callback) {
                    const callbackId = 'callback_' + Date.now();
                    this.callbacks[callbackId] = callback;
                    jsonData['callbackId'] = callbackId;
                }

                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.nativeHandler) {
                    window.webkit.messageHandlers.nativeHandler.postMessage(JSON.stringify(jsonData));
                } else if (window.AndroidBridge && window.AndroidBridge.processAction) {
                    window.AndroidBridge.processAction(JSON.stringify(jsonData));
                } else {
                    console.log("Native interface not available");
                }
            }

            call(to) {
                const callObject = {
                    action: "call",
                    body: { to: to }
                };
                this.sendMessageToNativeApp(callObject);
            }

            acceptCall(from) {
                const request = {
                    action: "accept-call",
                    body: { from: from }
                };
                this.sendMessageToNativeApp(request);
            }

            rejectCall(from) {
                const request = {
                    action: "reject-call",
                    body: { from: from }
                };
                this.sendMessageToNativeApp(request);
            }

            store(key, value) {
                const request = {
                    action: "store",
                    body: { key: key, value: value }
                };
                this.sendMessageToNativeApp(request);
            }

            fetch(key, d_value, callback) {
                const request = {
                    action: "fetch",
                    body: { key: key, d_value: d_value }
                };
                this.sendMessageToNativeApp(request, callback);
            }

            getLogs() {
                const request = {
                    action: "get-logs",
                    body: { range: 10 }
                };
                this.sendMessageToNativeApp(request);
            }

            ring(to) {
                this.setPage('ringing', { key: "to", value: to });
            }

            callStarted(_with) {
                this.setPage('inCall', { key: "to", value: _with });
            }

            callEnded() {
                this.setPage('main');
            }

            receivingCall(from) {
                this.setPage('incomingCall', { key: "from", value: from });
            }

            dataFetched(jsonData) {
                console.log('Received raw data:', JSON.stringify(jsonData));
                try {
                    if (jsonData.CallLog) {
                        const invLogData = jsonData.CallLog;
                        console.log("Inventory Log Data:", invLogData);

                        const iframe = document.getElementById("screen");
                        if (iframe) {
                            iframe.contentWindow.postMessage(JSON.stringify(jsonData), "*");
                        }
                    } else {
                        console.log("Unhandled key or missing data structure in:", JSON.stringify(jsonData));
                    }
                } catch (error) {
                    console.error("Error parsing JSON or processing data:", error);
                }
            }

            receiveData(_data) {
                this.handleData(_data);
            }

            handleData(_data) {
                try {
                    const data = typeof _data === 'string' ? JSON.parse(_data) : _data;
                    const action = data.action;
                    const body = data.body;
                    switch (action) {
                        case 'ringing':
                            this.ring(body.to);
                            break;
                        case 'call-started':
                            this.callStarted(body.from);
                            break;
                        case 'call-ended':
                            this.callEnded(body.from);
                            break;
                        case 'receiving-call':
                            this.receivingCall(body.from);
                            break;
                        case 'data-retrieved':
                            this.dataFetched(body);
                            break;
                        default:
                            console.log('Unknown action:', action);
                            break;
                    }
                } catch (error) {
                    console.error("Error handling data:", error);
                }
            }
        }

        window.addEventListener('message', function (event) {
            console.log(event);
            if (event.origin !== "https://htmltest-theta.vercel.app") {
                return;
            }
            console.log(JSON.stringify(event.data));
            const data = JSON.parse(event.data);
            console.log(data);
            switch (data.action) {
                case 'call':
                    controller.call(data.to);
                    break;
                case 'end-call':
                    controller.rejectCall(data.to);
                    break;
                case 'accept-call':
                    controller.acceptCall(data.from);
                    break;
                case 'reject-call':
                    controller.rejectCall(data.from);
                    break;
                case 'store':
                    controller.store(data.key, data.value);
                    break;
                case 'fetch':
                    controller.fetch(data.key, data.d_value, function (response) {
                        event.source.postMessage(JSON.stringify({ key: data.key, value: response }), event.origin);
                    });
                    break;
                case 'get-logs':
                    controller.getLogs();
                    break;
                default:
                    console.log('Unknown action');
                    break;
            }
        }, false);
    </script>
</body>
</html>
