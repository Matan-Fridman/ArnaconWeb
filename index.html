<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDK Interface</title>
</head>
<body>
    <iframe id="background-frame" src="background.html" style="width:100%; height:100%; border:none;"></iframe>
    <script>
        class Controller {
            constructor() {
                this.backgroundFrame = document.getElementById("background-frame");
                this.callbacks = {};
            }

            sendMessageToNativeApp(jsonData, callback = null) {
                if (callback) {
                    const callbackId = 'callback_' + Date.now();
                    this.callbacks[callbackId] = callback;
                    jsonData['callbackId'] = callbackId;
                }

                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.nativeHandler) {
                    window.webkit.messageHandlers.nativeHandler.postMessage(JSON.stringify(jsonData));
                } else if (window.AndroidBridge && window.AndroidBridge.processAction) {
                    window.AndroidBridge.processAction(JSON.stringify(jsonData));
                } else {
                    console.log("Native interface not available");
                }
            }

            postToBackground(data) {
                this.backgroundFrame.contentWindow.postMessage(JSON.stringify(data), "*");
            }

            handleMessageFromBackground(event) {
                if (event.origin !== window.location.origin) {
                    return;
                }

                const data = JSON.parse(event.data);
                switch (data.action) {
                    case 'call':
                        this.call(data.to);
                        break;
                    case 'end-call':
                        this.rejectCall(data.to);
                        break;
                    case 'accept-call':
                        this.acceptCall(data.from);
                        break;
                    case 'reject-call':
                        this.rejectCall(data.from);
                        break;
                    case 'store':
                        this.store(data.key, data.value);
                        break;
                    case 'fetch':
                        this.fetch(data.key, data.d_value, function (response) {
                            event.source.postMessage(JSON.stringify({ key: data.key, value: response }), event.origin);
                        });
                        break;
                    case 'get-logs':
                        this.getLogs();
                        break;
                    default:
                        console.log('Unknown action');
                        break;
                }
            }

            receiveData(_data) {
                const data = JSON.parse(_data);
                this.postToBackground(data);
            }

            call(to) {
                this.sendMessageToNativeApp({ action: "call", body: { to: to } });
            }

            acceptCall(from) {
                this.sendMessageToNativeApp({ action: "accept-call", body: { from: from } });
            }

            rejectCall(from) {
                this.sendMessageToNativeApp({ action: "reject-call", body: { from: from } });
            }

            store(key, value) {
                this.sendMessageToNativeApp({ action: "store", body: { key: key, value: value } });
            }

            fetch(key, d_value, callback) {
                this.sendMessageToNativeApp({ action: "fetch", body: { key: key, d_value: d_value } }, callback);
            }

            getLogs() {
                this.sendMessageToNativeApp({ action: "get-logs", body: { range: 10 } }, (response) => {
                    this.postToBackground({ action: "logs-retrieved", body: response });
                });
            }
        }

        const controller = new Controller();

        window.addEventListener('message', function (event) {
            controller.handleMessageFromBackground(event);
        }, false);

        // Expose receiveData method for native code to call
        window.receiveData = (data) => {
            controller.receiveData(data);
        };
    </script>
</body>
</html>
